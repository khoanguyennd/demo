<?php
$account = $_SESSION['accountshopping'];
$page = $this->getData('page');

$m_start = $this->getData('m_start');
$m_end = $this->getData('m_end');
$m_supplier = $this->getData('m_supplier');
$m_channel = $this->getData('m_channel');
$m_status = $this->getData('m_status');
$m_key = $this->getData('m_key');
$m_name = $this->getData('m_name');

$list_supplier = $this->getData('supplierSelect');
$list_channel = $this->getData('list_channel');
?>

<link rel="stylesheet" type="text/css" href="<?= URL_PUBLIC ?>css/jquery-ui.css" />
<script type="text/javascript" src="<?= URL_PUBLIC ?>js/jquery-ui.js"></script>
<script type="text/javascript">
    window.onload = function () {
        document.multiselect('#channelSelect');
    };

    $(document).ready(function () {
        $.onchangetime = function (name) {
            var d = new Date();
            $('input.datepick[name="dateend"]').val($.getFormattedDate(d.getFullYear(), (d.getMonth() + 1).toString(), d.getDate().toString()));
            $.datepickMilisecond('input.datepick[name="dateend"]');
            if (name == 'week') {
                d.setDate(d.getDate() - 7);
            }
            if (name == 'month') {
                d.setMonth(d.getMonth() - 1);
            }
            if (name == 'threemonth') {
                d.setMonth(d.getMonth() - 3);
            }
            $('input.datepick[name="datestart"]').val($.getFormattedDate(d.getFullYear(), (d.getMonth() + 1).toString(), d.getDate().toString()));
            $.datepickMilisecond('input.datepick[name="datestart"]');
        }
        $('.changepick').on('click', function () {
            $(this).closest('td').find('input.btn').removeClass('active');
            $(this).addClass('active');
            $.onchangetime($(this).attr('name'));
        });
        //$('.btn.changepick[name="week"]').click();

        // Hiển thị form trả lời hoặc chỉnh sửa câu hỏi
        $('#question').on('click', '.manager', function () {
            var qsid = $(this).attr('data-qsid');
            var channel= $(this).attr('data-channel');
            var dealid = $(this).attr('data-dealid');
            if(channel=="TMON")
            	window.open("http://www.tmon.co.kr/deal/"+dealid);
            if(channel=="COUPANG")
            	window.open("https://trip.coupang.com/tp/products/"+dealid);
            if(channel=="WMAKE")
            	window.open("https://tour.wd.wemakeprice.com/activity/direct/detail/"+dealid);
//             if ($.isNumeric(qsid)) {
//                 $.fn_ajax('viewform', {'qsid': qsid}, function (result) {
                    
//                     if (result.flag == true) {
//                         $.fn_popup(true, 'question');
//                         $($.elt_popup).find('.question .content p a').attr('href', result.qsproductlink).text(result.qsproduct);
//                         $($.elt_popup).find('.question .content input').val(result.qsmessage);
//                         $($.elt_popup).find('.question .content textarea').val(result.qsreply);
                        //$($.elt_popup).find('.question .content p').html(result.qsreply.length+"/100 "+'<?= $this->language('l_warnname') ?>');		
//                         $($.elt_popup).find('.question .control input').attr({'data-qsid': result.qsid, 'data-createdreply': result.createdreply});
//                     }
//                 }, false, false);
//             }
        });
        // Thực hiện trả lời hoặc chỉnh sửa câu trả lời
        $($.elt_popup + ' .question form').on('submit', function () {
            var qsid = $(this).find('.control input').attr('data-qsid');
            //var createdreply = $(this).find('.control input').attr('data-createdreply');
            var messagereply = $(this).find('textarea').val();
            if (messagereply && qsid) {
                $.fn_popup(false, 'question');
                $.fn_ajax('excuteform', {'qsid': qsid, 'messagereply': messagereply}, function (result) {
                    if (result.flag == true) {
                        var element = $('#question .manager[data-qsid="' + qsid + '"]').val('답변보기').closest('tr');
                        //$(element).find('td:nth-child(12)').text(result.createdreply);
                        $(element).find('td:nth-child(3)').text('<?= $this->language('l_anwserdone') ?>');
                    }
                }, true);
            }
            return false;
        });
        // Thay đổi số dòng hiển thị trên một trang
        $('div.question').on('change', 'select.select', function () {
            var length = $(this).val();
            if (length) {
            	console.log(length );
                $.fn_ajax('pagination', {'page': 1, 'length': length}, function (result) {
                	 console.log(result);
                    $.fn_result(result);
                }, true);
            }
            return false;
        });
        // Thực hiện phân trang
        $('div.question').on('click', '.pagination a', function () {
            var length = $(this).attr('data-length');
            var page = $(this).attr('data-page');
            if (length && page) {
            	console.log(length +"-" +page);
                $.fn_ajax('pagination', {'page': page, 'length': length}, function (result) {
                    $.fn_result(result);
                    return false;
                }, true);
            }
            return false;
        });
        // Hàm xử lý kết quả trả về		
        $.fn_result = function (data) {
            if (data.flag == true) {
                document.getElementById('divquestionbody').innerHTML = data.divquestionbody;
                document.getElementById('divpaging').innerHTML = data.divpaging;
            }
        }
        // Thực hiện tại xuất file excel
        $('button.downloadExcel').on('click', function (result) {
            var tbody = $('.table').find('td.empty');
            if (tbody.length > 0) {
                //
            } else {
                var titleName = $('#contents .ct_head h3').text();
                var description = $('#contents .ct_head p').text();
                if (titleName && description) {
                    window.open(encodeURI(jsData.urlAjax + 'downloadExcel?titleName=' + titleName + '&description=' + description));
                }
            }
        });
    });
</script>
<div class="ct_head">
    <h3><?= $this->language('l_question1') ?></h3>
    <p>
        <?= date('m') ?>월<?= date('d') ?>일 <?= date('H') ?>시<?= date('i') ?>분  <?= $this->language('l_listproduct11') ?> (<?= $this->language('l_listproduct12') ?>) 
        <a href="" class="btn small" onclick='document.getElementById("mform").submit();'><?= $this->language('l_update') ?></a>
    </p>
</div>
<div class="ct_content">
    <div class="form_group">
        <form class="search_member" action="" method="POST" name="mform" id="mform">
            <table class="table">
                <tr>
                    <th><?= $this->language('l_question3') ?></th>
                    <td colspan="3">
                        <input type="text" class="input datepick" name="datestart" value="<?= $m_start ?>" readonly="readonly"> 
                        <span>~</span> 
                        <input type="text" class="input datepick" name="dateend" value="<?= $m_end ?>" readonly="readonly"> 
                        <input type="button" class="btn changepick small" name="week" value="<?= $this->language('l_1week') ?>"> 
                        <input type="button" class="btn changepick small" name="month" value="<?= $this->language('l_1month') ?>"> 
                        <input type="button" class="btn changepick small" name="threemonth" value="<?= $this->language('l_3month') ?>">
                    </td>
                    <td rowspan="4" style="line-height: 40px;width: 100px;">
                        <input type="submit" class="btn full hover" name="m_search"  value="<?= $this->language('l_search') ?>"> 
                        <input type="submit" class="btn full hover reset" name="m_reset"  value="<?= $this->language('l_reset') ?>">
                    </td>
                </tr>
                <tr>
                    <th><?= $this->language('l_supplier') ?></th>
                    <td>
                        <select name="m_supplier" id="supplier" class="select small">
                            <option <?php if ($m_supplier == 0) echo 'selected="selected"'; ?> value="0">
                                <?= $this->language('l_question4') ?>
                            </option>
                            <?php foreach ($list_supplier as $value => $giatri) { ?>
                                <option <?php if ($m_supplier == $giatri['idx']) echo 'selected="selected"'; ?> value="<?= $giatri['idx'] ?>"><?= $giatri['ID'] ?></option>
                            <?php } ?>
                        </select>
                    </td>
                    <th><?= $this->language('l_channelsell') ?></th>
                    <td>
                        <select class="select small full" name="m_channel[]" id='channelSelect' multiple>
                            <?php foreach ($list_channel as $value => $giatri) { ?>
                                <option <?php if (in_array($giatri[1], $m_channel)) echo 'selected="selected"'; ?>
                                    value='<?= $giatri[1] ?>'><?= $giatri[1] ?></option>
                                <?php } ?>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th><?= $this->language('l_status') ?></th>
                    <td colspan="3">
                        <ul class="clearfix">
                            <li>
                                <input type="radio" id="forstatus1" name="m_status" value="all" <?php if ($m_status == 0) echo 'checked="checked" '; ?>> 
                                <label for="forstatus1"><?= $this->language('l_all') ?></label>
                            </li>
                            <li>
                                <input type="radio" id="forstatus2" name="m_status" value="1" <?php if ($m_status == 1) echo 'checked="checked" '; ?>>
                                <label for="forstatus2"><?= $this->language('l_anwserbefore') ?></label>
                            </li>
                            <li>
                                <input type="radio" id="forstatus3" name="m_status" value="2" <?php if ($m_status == 2) echo 'checked="checked" '; ?>>
                                <label for="forstatus3"><?= $this->language('l_anwserdone') ?></label>
                            </li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th><?= $this->language('l_keyword') ?></th>
                    <td>

                        <select class="select small full" name="m_key">
                            <option value="0" <?php if ($m_key == 0) echo 'selected="selected"'; ?> ><?= $this->language('l_question5') ?></option>
                            <option value="1" <?php if ($m_key == 1) echo 'selected="selected"'; ?> ><?= $this->language('l_nameproduct') ?></option>
                            <option value="2" <?php if ($m_key == 2) echo 'selected="selected"'; ?> ><?= $this->language('l_nameoption') ?></option>
                            <option value="3" <?php if ($m_key == 3) echo 'selected="selected"'; ?> ><?= $this->language('l_question6') ?></option>
                            <option value="4" <?php if ($m_key == 4) echo 'selected="selected"'; ?> ><?= $this->language('l_question7') ?></option>
                        </select>
                    </td>
                    <td colspan="2">
                        <input type="text" class="input full" name="m_name" value="<?= $m_name ?>" placeholder="<?= $this->language('l_keyword') ?>">
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div class="form_group clearfix question">
        <div class="form_table">
            <div class="table_head bgwhite">
                <div class="ctrl_head clearfix">
                    <div class="title col-xs-1">
                        <h3><?= $this->language('l_mbtotal') . $this->getData('total') ?> <?= $this->language('l_notification16') ?></h3>
                    </div>
                    <div class="icons col-xs-2">
                        <select name="" class="select">
                            <option value="20" <?= (($this->getData('length') == 20) ? 'selected' : '') ?>>20 <?= $this->language('l_notification8') ?></option>
                            <option value="50" <?= (($this->getData('length') == 50) ? 'selected' : '') ?>>50 <?= $this->language('l_notification8') ?></option>
                            <option value="100" <?= (($this->getData('length') == 100) ? 'selected' : '') ?>>100 <?= $this->language('l_notification8') ?></option>
                        </select>
                    </div>
                    <div class="icons col-xs-2">
                        <button type="button" name="downloadExcel" class="btn hover downloadExcel"><?= $this->language('l_Channel26') ?></button>
                    </div>
                </div>
            </div>
            <div class="table_content">
                <table class="table" id="question">
                    <thead>
                        <tr>
                            <th><?= $this->language('l_no') ?></th>
                            <th><?= $this->language('l_accmanage') ?></th>
                            <th style="width: 70px;"><?= $this->language('l_status') ?></th>
                            <th><?= $this->language('l_Channel7') ?></th>
                            <th><?= $this->language('l_question7') ?></th>
                            <th><?= $this->language('l_question5') ?></th>
                            <th><?= $this->language('l_nameproduct') ?></th>
                            <th><?= $this->language('l_nameoption') ?></th>
                            <th><?= $this->language('l_question_madh') ?></th>
                            <th><?= $this->language('l_question8') ?></th>
                            <th><?= $this->language('l_question6') ?></th>
                            <th style="width: 70px;"><?= $this->language('l_question3') ?></th>
                        </tr>
                    </thead>
                    <tbody id="divquestionbody"><?= $this->getData('question') ?></tbody> 
                </table>
            </div>
        </div>
        <div id="divpaging">
            <?= $this->getData('pagination') ?>
        </div>
    </div>

</div>