<?php

class ListproductController extends Controller
{

    // Phương thức khởi tạo
    public function __construct($params)
    {
        parent::__construct($params);
        $this->isLogin();
        $account = $_SESSION['accountshopping'];
        if($account['temp']==1)
            Url::header($this->route('account')."#tab1");
    }

    public function ListproductAction()
    {
        $account = $_SESSION['accountshopping'];
        $list_channel = array();
        $m_channel = array();
        $channel = $this->_model->loadRecords('channels');
        foreach ($channel as $value => $giatri) {
            $list_channel[] = array(
                $giatri['channel_id'],
                $giatri['channel_name']
            );
            $m_channel[]= $giatri['channel_id'];
        }
        $this->_view->setData('list_channel', $list_channel);

        $sqlheader = "SELECT p.*,u.ID as nameSupplier,d.channel_name,d.travelProductId,d.status,d.useStartedAt1,d.useEndedAt1,
                             d.id as salechannelId,d.channel_id,d.productId,d.type_depth1,d.type_depth2,d.type_depth3,d.type_depth4 ";
        $sql = "FROM `tb_sellerproduct` p LEFT JOIN (SELECT c.*,t.type_depth1,t.type_depth2,t.type_depth3,t.type_depth4,n.channel_name, DATE_FORMAT(c.useStartedAt,'%Y-%m-%d') as useStartedAt1, DATE_FORMAT(c.useEndedAt,'%Y-%m-%d') as useEndedAt1,n.channel_id 
                	                                 FROM `tb_salechannel` c,`tb_sellerproduct` p,tb_channels n , tb_channeltypes t
                                                     WHERE p.sellerProductId=c.sellerProductId AND c.channelTypeId=t.type_id AND t.channelid=n.channel_id AND c.isDelete=0) d
                ON p.sellerProductId=d.sellerProductId LEFT JOIN tb_user u ON p.supplier=u.idx ";
        
        if($account['role']==0){
            $sql.= "WHERE 1!=-1 ";
        }else{
            $sql.= "WHERE (p.creator='".$account['ID']."' OR p.creator IN (SELECT u2.ID FROM tb_user u1 ,tb_user u2
								WHERE u1.ID = '".$account['ID']."' AND u2.idx_parent=u1.idx) ) ";
        }
        // Search top
        if(isset($this->_params['searchtopkeyword'])){
            $searchtopkeyword = $this->_params['searchtopkeyword'];
            $sql.= " AND (p.name LIKE '%$searchtopkeyword%' OR p.sellerProductId LIKE '%$searchtopkeyword%') ";
        }
        // Search
        if (isset($this->_params['m_search'])) {
            $m_start = $this->_params['m_start'];
            $m_end = $this->_params['m_end'];
            $m_keytime = $this->_params['m_keytime'];
            $nolimittime = 0;
            if (isset($this->_params['nolimittime'])) {
                $nolimittime = 1;
                $sql .= " AND p.nolimittime=$nolimittime ";
            } else {
                if($m_keytime == 0 )
                $sql .= " AND d.useStartedAt1>='$m_start' AND d.useStartedAt1<='$m_end' ";
                if($m_keytime == 1 )
                $sql .= " AND  d.useEndedAt1>='$m_start' AND d.useEndedAt1<='$m_end'  ";
            }

            $m_supplier = $this->_params['m_supplier'];
            if ($m_supplier != 0)
                $sql .= "AND p.supplier=$m_supplier ";
            
            $m_channel = array();
            if (isset($this->_params['m_channel'])) {
                $m_channel = $this->_params['m_channel'];
                if (count($m_channel) > 0) {
                    $sql .= "AND ( ";
                    foreach ($m_channel as $value => $giatri) {
                        $sql .= "d.channel_id=$giatri OR ";
                    }
                    $sql = mb_substr($sql, 0, - 3);
                    $sql .= " ) ";
                }
            }

            $m_status = $this->_params['m_status'];
            if ($m_status != 10) {
                $sql .= "AND d.status=$m_status ";
            }

            
            $type1Id = $this->_params['type1Id'];
            if($type1Id!="0") $sql .= ' AND d.type_depth1="'.$type1Id.'" ';
            
            $type2Id = $this->_params['type2Id'];
            if($type2Id!="0") $sql .= ' AND d.type_depth2="'.$type2Id.'" ';
            
            $type3Id = $this->_params['type3Id'];
            if($type3Id!="0") $sql .= ' AND d.type_depth3="'.$type3Id.'" ';
            
            $type4Id = $this->_params['type4Id'];
            if($type4Id!="0") $sql .= ' AND d.type_depth4="'.$type4Id.'" ';
            
            

            $m_key = $this->_params['m_key'];
            $m_name = $this->_params['m_name'];
            if ($m_key == 0) {
                $sql .= "AND p.name LIKE '%$m_name%' ";
            }
            if ($m_key == 1) {
                $sql .= "AND p.sellerProductId LIKE '%$m_name%' ";
            }
        } else {
            $date = date("Y-m-d");
            $date = strtotime(date("Y-m-d", strtotime($date)) . "-2 months");
            //$m_start = date("Y-m-d", $date);
            $m_start = date("Y-m-d");
            $m_end = date("Y-m-d");
            
            $nolimittime = 0;
            $m_supplier = 0;
            $m_status = 10;
            $type1Id = "0";
            $type2Id = "0";
            $type3Id = "0";
            $type4Id = "0";
            $m_key = 0;
            $m_name = "";
        }
        $data = $this->_model->loadRecords('channeltypes');
        $type_depth=[];
        foreach ($data as $value => $giatri)
        {
            $type_depth[$giatri['type_depth1']][$giatri['type_depth2']][$giatri['type_depth3']][$giatri['type_depth4']]=[$giatri['type_id'],$giatri['type_rate']];
        }
        $this->_view->setData('type_depth', $type_depth);
        // status salechannel useEndedAt        
        $methods = [
        	'insale'=>' AND d.status=2 ',
        	'endsale'=>' AND d.status=2 AND d.useEndedAt1='.strtotime(date('Y-m-d', time())).' ',
        	'onsale'=>' AND d.status=3 '
        ];
        if(isset($methods[$this->_params['method']])){
        	$sql .= $methods[$this->_params['method']];
        }        
        
        $this->_view->setData('m_start', $m_start);
        $this->_view->setData('m_end', $m_end);
        $this->_view->setData('m_channel', $m_channel);
        $this->_view->setData('m_status', $m_status);
        $this->_view->setData('m_supplier', $m_supplier);
        $this->_view->setData('nolimittime', $nolimittime);
        $this->_view->setData('type1Id', $type1Id);
        $this->_view->setData('type2Id', $type2Id);
        $this->_view->setData('type3Id', $type3Id);
        $this->_view->setData('type4Id', $type4Id);
        $this->_view->setData('m_key', $m_key);
        $this->_view->setData('m_name', $m_name);
        
        $sql.=" ORDER BY p.id DESC ";
        

        $_SESSION['sqllistproduct'] = $sql;

        // Tham số phân trang
        $length = ($this->_params['length'] ? $this->_params['length'] : DEFAULT_LENGTH);
        $page = ($this->_params['page'] ? $this->_params['page'] : 1);
        $begin = ($page - 1) * $length;
        $this->_view->setData('page', $page);
        $this->_view->setData('length', $length);

        $this->_model->setQuery("SELECT count(*) as count " . $sql);
        $result = $this->_model->readAll();
        $this->_view->setData('count', $result[0]['count']);
        
        $pagination = $this->paginationParams($result[0]['count'], $this->route('listproduct', ['method'=>$this->_params['method']]));
        $this->_view->setData('pagination', $pagination['pagination']);

        //echo $sqlheader . $sql . " LIMIT " . $begin . "," . $length;

        $this->_model->setQuery($sqlheader . $sql . " LIMIT " . $begin . "," . $length);
        $products = $this->_model->readAll();
        $dem = 0;
        $list_product = array();
        foreach ($products as $value => $giatri) {
            $dem ++;
            $list_product[] = array(
                $giatri['id'],
                $giatri['sellerProductId'],
                $giatri['name'],
                $giatri['nameSupplier'],
                $giatri['type_depth1'],
                $giatri['type_depth2'],
                $giatri['type_depth3'],
                $giatri['type_depth4'],
                $giatri['channel_name'],
                $giatri['productId'],
                $giatri['status'],
                $giatri['useStartedAt1'],
                $giatri['useEndedAt1'],
                $giatri['salechannelId'],
                $giatri['productId']
            );
        }
        $this->_view->setData('list_product', $list_product);
        $list_supplier = $this->_model->loadRecords('user', [
            'idx_parent' => $account['idx']
        ]);
        $this->_view->setData('list_supplier', $list_supplier);
        
        
        $this->_view->setData('dem', $dem);

        $this->_view->render('listproduct');
    }

    // /
    public function stopsaleAjax()
    {
        $result = [
            'flag' => false
        ];
        $checkproduct = $this->_params['checkproduct'];
        $stopsale = $this->_params['stopsale'];
        foreach ($checkproduct as $value => $giatri) {
            $result['flag'] = false;
            $pieces = explode(";", $giatri);
            $data = $this->_model->updateRecord('salechannel', [
                'useEndedAt' => "$stopsale",
                'statusedit' => 1
            ], [
                'id' => $pieces[1]
            ]);
            if ($data) {
                $result['flag'] = true;
            }

        }

        echo json_encode($result);
    }

    // /
    public function changeStatusAjax()
    {
        $result = [
            'flag' => false
        ];
        $act = $this->_params['act'];
        if ($act == "approve") {
            $checkproduct = $this->_params['checkproduct'];
            foreach ($checkproduct as $value => $giatri) {
                $result['flag'] = false;
                $pieces = explode(";", $giatri);
                $data = $this->_model->updateRecord('salechannel', [
                    'status' => 2,
                    "statusedit" => 1
                ], [
                    'id' => $pieces[1]
                ]);
                if ($data) {
                    $result['flag'] = true;
                }
            }
        }

        if ($act == "stop") {
            $checkproduct = $this->_params['checkproduct'];
            foreach ($checkproduct as $value => $giatri) {
                $result['flag'] = false;
                $pieces = explode(";", $giatri);
                $data = $this->_model->updateRecord('salechannel', [
                    'status' => -1,
                    "statusedit" => 1
                ], [
                    'id' => $pieces[1]
                ]);
                if ($data) {
                    $result['flag'] = true;
                }
            }
        }
        if ($act == "open") {
            $checkproduct = $this->_params['checkproduct'];
            foreach ($checkproduct as $value => $giatri) {
                $result['flag'] = false;
                $pieces = explode(";", $giatri);
                $data = $this->_model->updateRecord('salechannel', [
                    'status' => 2,
                    "statusedit" => 1
                ], [
                    'id' => $pieces[1]
                ]);
                if ($data) {
                    $result['flag'] = true;
                }
            }
        }
        
        
        
        echo json_encode($result);
    }

    // Phương thức phân trang ajax
    public function paginationAjax()
    {
        $result1 = [
            'flag' => false
        ];
        // Tham số phân trang
        $length = ($this->_params['length'] ? $this->_params['length'] : DEFAULT_LENGTH);
        $page = ($this->_params['page'] ? $this->_params['page'] : 1);

        $begin = ($page - 1) * $length;

        $sql = $_SESSION['sqllistproduct'];

        $this->_model->setQuery("SELECT count(*) as count " . $sql);
        $result = $this->_model->readAll();
        $this->_view->setData('count', $result[0]['count']);

        $pagination = $this->paginationParams($result[0]['count'], $this->route('listproduct', ['method'=>'sale']));
        $result1['divpaging'] = $pagination['pagination'];

        $sqlheader = "SELECT p.*,u.ID as nameSupplier,  d.channel_name,d.travelProductId,d.status,d.useStartedAt1,d.useEndedAt1,
                            d.id as salechannelId,d.channel_id,d.productId,d.type_depth1,d.type_depth2,d.type_depth3,d.type_depth4 ";
       // echo $sqlheader . $sql . " LIMIT " . $begin . "," . $length;
        $this->_model->setQuery($sqlheader . $sql . " LIMIT " . $begin . "," . $length);
        
        $products = $this->_model->readAll();
        $list_product = array();
        foreach ($products as $value => $giatri) {
            $list_product[] = array(
                $giatri['id'],
                $giatri['sellerProductId'],
                $giatri['name'],
                $giatri['nameSupplier'],
                $giatri['type_depth1'],
                $giatri['type_depth2'],
                $giatri['type_depth3'],
                $giatri['type_depth4'],
                $giatri['channel_name'],
                $giatri['productId'],
                $giatri['status'],
                $giatri['useStartedAt1'],
                $giatri['useEndedAt1'],
                $giatri['salechannelId'],
                $giatri['productId']
            );
        }

        $vitri = 0;
        $listproductbody = "";
        foreach ($list_product as $value => $giatri) {
            $vitri ++;
           
            $l_status = "";
            if ($giatri[10] == 0)
                $l_status = $this->_view->getItem('language', 'l_status0');
            if ($giatri[10] == 1)
                $l_status = $this->_view->getItem('language', 'l_status1');
            if ($giatri[10] == 2)
                $l_status = $this->_view->getItem('language', 'l_status2');
            if ($giatri[10] == 3)
                $l_status = $this->_view->getItem('language', 'l_status3');
            if ($giatri[10] == 4)
                $l_status = $this->_view->getItem('language', 'l_status4');
            if ($giatri[10] == - 1)
                $l_status = $this->_view->getItem('language', 'l_status_1');
            $href='';
            if($giatri[8] == 'COUPANG' )
			    $href="https://trip.coupang.com/tp/products/$giatri[14]";  
			if($giatri[8] == 'TMON' )
			    $href="http://www.tmon.co.kr/deal/$giatri[14]";
			if($giatri[8] == 'WMAKE' )
				$href="https://tour.wd.wemakeprice.com/activity/direct/detail/$giatri[14]";
			
            $str='<input type="checkbox" name="checkproduct[]" class="checkbox" data-checkbox="' . $giatri[13] . '" value="' . $giatri[10] . ';' . $giatri[13] . '" id="checkproduct' . $vitri . '">';
            $listproductbody .= '
			     <tr>
					<td>'.$str.'</td>
					<td><input type="button" onclick="window.location.assign(\'' . URL_BASE . '/editticket1.html/' . $giatri[1] . '\')" class="btn hover small" value="' . $this->_view->getItem('language', 'l_edit') . '"></td>
					<td>' . $giatri[1] . '</td>
					<td>' . $giatri[2] . '</td>
					<td>' . $giatri[3] . '</td>
					<td>' . $giatri[4] . '>' . $giatri[5] . '>' . $giatri[6] . '>' . $giatri[7] . '</td>
					<td>' . $giatri[8] . '</td>
					<td><a href="'.$href.'" target="_blank">' . $giatri[9] . '</a></td>
					<td class="status" data-status="' . $giatri[13] . '">' . $l_status . '</td>
					<td>' . $giatri[11] . '</td>
					<td class="stopsale" data-stopsale="' . $giatri[13] . '">' . $giatri[12] . '</td>

				</tr>';
        }
        if($vitri==0)
            $listproductbody .= '<tr><td colspan="11" class="empty">'.$this->_view->getItem('language', 'l_rowemptydata').'</td></tr>';
            

        $result1['listproductbody'] = $listproductbody;
        $result1['flag'] = true;

        echo json_encode($result1);
    }

    // Phương thức ajax
    public function savechecklistAjax()
    {
        $result = ['flag' => false ];
        $email1 = $this->_params['email1'];
        $email2 = $this->_params['email2'];
        $email3 = $this->_params['email3'];
        $checkproduct = $this->_params['checkproduct'];
        foreach ($checkproduct as $value => $giatri) {
            $pieces = explode(";", $giatri);
            $this->_model->deleteRecord('emailcheck', ["sellerProductId" => $pieces[1]]);
            $this->_model->insertRecord('emailcheck', [
                'sellerProductId' => $pieces[1],
                'email1' => $email1,
                'email2' => $email2,
                'email3' => $email3
            ]);
        }
       
        $result['flag'] = true;
        echo json_encode($result);
    }
    public function changeType1Ajax()
    {
        $type_depth = $_SESSION['type_depth'];
        $type_depth1 = $this->_params['id_type1'];
        $str='<select style="width: 150px; height: 24px;" class="TextBoxField" onchange="changeType2(this.value)" name="type2Id" id="type2Id">';
        $str.='<option value="0"  selected="selected" >'.$this->_view->getItem('language', 'l_question4').'</option>';
        
        if($type_depth1!="0")
        foreach ($type_depth[$type_depth1] as $value => $giatri) {
                $str .= '<option value="'.$value.'" >'. $value. '</option>';
        }
        
        $str.='</select>';
        echo $str;
    }

    public function changeType2Ajax()
    {
        $type_depth = $_SESSION['type_depth'];
        $type_depth1 = $this->_params['id_type1'];
        $type_depth2 = $this->_params['id_type2'];
        $str='<select style="width: 150px; height: 24px;" class="TextBoxField" onchange="changeType3(this.value)" name="type3Id" id="type3Id">';
        $str.='<option value="0"  selected="selected">'.$this->_view->getItem('language', 'l_question4').'</option>';

        if($type_depth2!="0")
        foreach ($type_depth[$type_depth1][$type_depth2]  as $value => $giatri) {
                $str .= '<option value="'.$value.'" >'. $value. '</option>';
        }
        $str.='</select>';
        echo $str;
    }
    public function changeType3Ajax()
    {
        $type_depth = $_SESSION['type_depth'];
        $type_depth1 = $this->_params['id_type1'];
        $type_depth2 = $this->_params['id_type2'];
        $type_depth3 = $this->_params['id_type3'];
        $str="";
        
        $str='<select style="width: 150px; height: 24px;" class="TextBoxField" name="type4Id" id="type4Id">';
        $str.='<option value="0" selected="selected">'.$this->_view->getItem('language', 'l_question4').'</option>';
        
        if($type_depth3!="0")
        if(count($type_depth[$type_depth1][$type_depth2][$type_depth3])>0){
            foreach ($type_depth[$type_depth1][$type_depth2][$type_depth3]   as $value => $giatri) {
                    $str .= '<option value="'.$value.'">'. $value. '</option>';
            }
        }
        $str.='</select>';
        
        echo $str;
    }
    
    // Phương thức download file excel
    public function downloadExcelAjax(){
        $format = Func::config('listproductDownloadExcel');
        if($format){
            $sqlheader = "SELECT p.*,u.ID as nameSupplier,  d.channel_name,d.travelProductId,d.status,d.useStartedAt1,d.useEndedAt1,
                            d.id as salechannelId,d.channel_id,d.productId,d.type_depth1,d.type_depth2,d.type_depth3,d.type_depth4 ";
            $sql = $_SESSION['sqllistproduct'];
            $this->_model->setQuery($sqlheader . $sql);
            $products = $this->_model->readAll();

            foreach ($products as $value => $giatri) {
                $type_depth="";
                $type_depth.= $giatri['type_depth1'];
                $type_depth.= '>';
                $type_depth.=  $giatri["type_depth2"];
                $type_depth.= '>';
                $type_depth.=  $giatri["type_depth3"];
                $type_depth.= '>';
                $type_depth.=  $giatri['type_depth4'];
                
                $products[$value]['type_depth']=$type_depth;
                if($giatri['status']=="")
                    $products[$value]['status']=0;
            }
            if($products){
                $format['export']['titleName'] = "aaa";
                $format['export']['description'] = "bbb";
                $excel = new OfficeExcel();
                $excel->write($format['filename'], $products, $format['columns'], $format['export']);
            }
        }
    }
}
?>