import React, { PureComponent } from 'react';
import { View, Text, StyleSheet, AsyncStorage, TouchableOpacity } from 'react-native';
import { Header } from 'react-native-elements';
import { Left, Right} from 'native-base';
import { ActivityIndicator, FlatList } from 'react-native';
import {Modal, TouchableHighlight, CheckBox, TextInput, Button } from 'react-native';
import Icon from 'react-native-vector-icons/FontAwesome';
import Pagination from 'react-native-pagination';
import {List, ListItem, SearchBar} from "react-native-elements";
//import { DataTable, DataTableCell, DataTableRow, DataTablePagination } from 'material-bread';
import { DataTable } from 'react-native-paper';

import { data } from './define';
const server = data[0];

export default class TabOrderAll extends PureComponent {
      static navigationOptions = {
           title: 'Quản lý đơn hàng',
           headerStyle: {
             color: '#DB4437'
           },
           headerTintColor: '#DB4437',
           headerTitleStyle: {
              fontWeight: 'bold',
           },
      };

    constructor(props) {
         super(props);
         this.state = {
           loading: false,
           page: 1,
           perPage: 50,
           totalRow: 0,
           dataApi: [],
           isLoading: true,
           username: "",
           date:  new Date().getSeconds(),
           isSelected: false,
           refreshing: false,
           datasearch: [],
           searchtext: '',
           days: ["jan","feb","Mar"],
           modalVisible: false
         };

         this.loadPagination = this.loadPagination.bind();
         this.loadMoreOrderAPI = this.loadMoreOrderAPI.bind();
    }

    componentDidMount() { //auto run function
           //console.log('method: ', this.props.method); // Get method
           // get session
           AsyncStorage.getItem('accountshopping', (err, result) => {

                       //console.log('user', result);

                       this.setState({loading: true});
                       fetch(server+'orderApi.html', {
                               method: 'POST',
                               headers: {
                                 Accept: 'application/json',
                                 'Content-Type': 'application/json',
                               },
                               body: JSON.stringify({
                                  account_idx: JSON.parse(result).account_idx,
                                  account_ID: JSON.parse(result).account_ID,
                                  account_role: JSON.parse(result).account_role,
                                  method: this.props.method,
                                  page : this.state.page,
                                  datasearch : this.state.datasearch

                               }),
                             })
                        .then((response) => response.json())
                        .then((responseJson) => {
                            //console.log(this.state.datasearch);
                            console.log(responseJson);
                            if (responseJson.result) {
                                // console.log('page mount', this.state.page);
                                // console.log('ticket number', responseJson.list_order.data[0].ticketNumber);
                                this.setState({dataApi: responseJson.list_order.data , totalRow: responseJson.list_order.count, loading: false,  refreshing: false });
                                 //this.setState({dataApi: this.state.page === 1 ? responseJson.list_order.data : [...this.state.dataApi, ...responseJson.list_order.data], totalRow: responseJson.list_order.count, loading: false,  refreshing: false });
                            }
                        })
                        .catch((error) => this.setState({loading: false}))
                        .finally(() => {
                             this.setState({ isLoading: false });
                        });
           });
     }

     submitSearch(event) {
        //console.log('searchtext', this.state.searchtext);

       let search= {
            "text_ten_phone_mave" : this.state.searchtext,
            "thoigian" : "0_2019-08-13_2020-08-13",
            "checked_kenh" : "all",
            "check_ncc" : 'all'
            };
        this.setState({datasearch: search});

        //  console.log('search find ', search);
        //this.setState({date: new Date().getSeconds()});
        this.setState(
                         {
                             datasearch: search,
                             date: new Date().getSeconds()
                         },
                         () => {
                             console.log('search find ', this.state.datasearch);
                             this.componentDidMount();
                         }
                     );
     }


    loadMoreOrderAPI = (page) => {

             this.setState(
                 {
                     page: page
                 },
                 () => {

                     this.componentDidMount();
                 }
             );

     };


     loadPagination = () => {
        let totalPage = Math.floor(this.state.totalRow / this.state.perPage);
        let dataPagination = [];
        let dataPaginationPre = [];
        let dataPaginationNext = [];
        // getPrePage

        if (this.state.page != 1) {
            dataPaginationPre.push(this.state.page -1);
        }

        // getNextPage
        if (this.state.page < totalPage) {
            dataPaginationNext.push(this.state.page + 1);
        }

        // get pagination
        // for (let i = (this.state.page - 4) > 0 ? (this.state.page - 4) : 1; i <= ((this.state.page + 4) > totalPage ? totalPage : (this.state.page + 4)); i += 1) {
        for (let i = this.state.page; i <= ((this.state.page + 4) > totalPage ? totalPage : (this.state.page + 4)); i += 1) {
            dataPagination.push(i);
        }

        return (
           <View style={{flex: 1, flexDirection: 'row'}}>
            {

                dataPaginationPre.map((item, index) => <View style={this.state.page == item ? styles.buttonPaginationActive : styles.buttonPagination} >
                                                <TouchableOpacity activeOpacity={0.95} onPress={() => this.loadMoreOrderAPI(item)} >
                                                    <Text > {"<"} </Text>
                                                </TouchableOpacity>
                                             </View>
                                     )
            }

            {

              dataPagination.map((item, index) => <View style={this.state.page == item ? styles.buttonPaginationActive : styles.buttonPagination} >
                                            <TouchableOpacity activeOpacity={0.95} onPress={() => this.loadMoreOrderAPI(item)} >
                                                <Text >{item}</Text>
                                            </TouchableOpacity>
                                         </View>
                                 )
            }

            {

                dataPaginationNext.map((item, index) => <View style={this.state.page == item ? styles.buttonPaginationActive : styles.buttonPagination} >
                                                <TouchableOpacity activeOpacity={0.95} onPress={() => this.loadMoreOrderAPI(item)} >
                                                    <Text > {">"} </Text>
                                                </TouchableOpacity>
                                             </View>
                                     )
            }
            </View>
        )
   };

    toggleModal(visible) {
      this.setState({ modalVisible: visible });
    }

    render () {
        const { navigation } = this.props;

        return (
            <View style={styles.container}>
                <View style={{ borderColor: '#ccc', backgroundColor: 'rgb(217, 217, 217)', borderWidth: 1 }}>
                    <View style={{height:50,  paddingTop:15, left: 20}}>
                       <View style={{flex: 1, flexDirection: 'row'}}>
                           <View style={{width: '79%'}} >
                               <TouchableOpacity activeOpacity={0.95}>
                                  <TextInput style={{borderWidth: 0.5, borderColor: '#607D8B', backgroundColor: '#fff'}} value={this.state.searchtext}
                                       onChangeText={searchtext =>
                                           this.setState({ searchtext })
                                       }
                                       ref={input => {
                                           this.textInput = input;
                                       }}  placeholder="홍길동 (name)"/>
                               </TouchableOpacity>
                           </View>
                       </View>
                    </View>
                    <View style={{height:50,  paddingTop:10, left: 20}}>
                       <View style={{flex: 1, flexDirection: 'row'}}>
                           <View style={{width: '79%', bottom: 5}} >
                               <TouchableOpacity activeOpacity={0.95}>
                                  <TextInput style={{borderWidth: 0.5, borderColor: '#607D8B', backgroundColor: '#fff'}}  />
                               </TouchableOpacity>
                           </View>
                       </View>
                    </View>
                </View>
                <View style={{width: '12%',  position: 'absolute', right: 70, top: 25}}>
                    <Icon.Button style={{ backgroundColor: '#DB4437', height: 30}}
                       name='search'
                        onPress={this.submitSearch.bind(this)}
                    >
                    </Icon.Button>
                </View>
                <View style={{width: '12%',   position: 'absolute', right: 70, top: 64}}>
                    <TouchableHighlight onPress = {() => {this.toggleModal(true)}}>
                       <Button
                               onPress = {() => {this.toggleModal(true)}}
                                title = "Op"
                                color = "red"
                             />
                    </TouchableHighlight>
                </View>
                {this.state.isLoading ? <ActivityIndicator size = "large"/> : (
                     <FlatList
                          data={this.state.dataApi}
                          keyExtractor={({ id }, index) => id}
                          renderItem={({ item, index }) => (

                          <View style= {styles.contentOrder}>
                              <View style={{flex: 1, flexDirection: 'row'}}>
                                 <View style={styles.contentOrderLeft}>
                                    <View>
                                        <Text style={styles.textPurcharse}>
                                        {item.statusTicket == -1? 'Hết hiệu lực' : item.statusTicket == 1? 'Mua xong'
                                            : item.statusTicket == 2? 'Đã sử dụng' : item.statusTicket == 3? 'Hết hạn sử dung'
                                            : item.statusTicket == 4? 'Hoàn tiền' : 'Hết hạn hoàn tiền'}
                                        </Text>
                                    </View>
                                    <View style={{ padding: '20%'}}>
                                        <CheckBox
                                          value={this.state.isSelected}

                                          style={styles.checkbox}
                                        />
                                    </View>
                                 </View>
                                 <View style={styles.contentOrderRight}>
                                    <Text style={styles.textbold}>T-Bridge: {item.ticketNumber}</Text>
                                    <Text style={styles.textbold}>Gmarket: {item.travelProductId}</Text>
                                    <View style={{marginTop: 10}}>
                                        <Text> {item.dealName} {this.state.date}</Text>
                                        <Text> {item.price}M [{item.name}]</Text>
                                        <Text> {item.userName} [{item.phoneNumber}]</Text>
                                        <Text> Ngày mua: [{item.purchaseDateTime}]</Text>
                                    </View>
                                 </View>
                              </View>
                        </View>
                    )}

                 />

             )}

                <View style={{ width: '100%', height: 35, marginTop:10,  alignItems: 'center', justifyContent: 'center'}}>
                      {this.loadPagination()}
                </View>
                <Modal animationType = {"slide"} transparent = {false}
                   visible = {this.state.modalVisible}
                   style={{width: '100%', backgroundColor: 'rgba(0,0,0,0.4)'}}
                   onRequestClose = {() => { console.log("Modal has been closed.") } }>
                   <View style={{flex: 1, flexDirection: 'row'}}>
                       <View style={{width: 50, height: 50}}>
                           <TouchableHighlight onPress = {() => {
                                this.toggleModal(!this.state.modalVisible)}}>
                                <Text style = {styles.text}>Đặt lại </Text>
                           </TouchableHighlight>
                        </View>
                       <View style={{width: 50, height: 50}}><Text>tình trạng chi tiết</Text></View>
                     </View>
                   <View style = {styles.modal}>
                      <Text style = {styles.text}>Modal is open!</Text>

                      <TouchableHighlight onPress = {() => {
                         this.toggleModal(!this.state.modalVisible)}}>

                         <Text style = {styles.text}>Close Modal</Text>
                      </TouchableHighlight>
                   </View>
                </Modal>
            </View>
        );
    }
}

const styles = StyleSheet.create({
   container: { flex: 1, padding: 10, backgroundColor: '#fff' },
   modal: {
     flex: 1,
     alignItems: 'center',
     backgroundColor: '#fefefe',
     padding: 10
   },
   textbold: {fontWeight: 'bold'},
   textPurcharse: {width: '70%', color: '#fff', backgroundColor: '#3b5998'},
   contentOrder: {borderColor: '#ccc', borderWidth: 1, marginTop: 10, padding: 10 },
   contentOrderLeft: {width: '30%'},
   contentOrderRight: {width: '70%', left: 15 },
   buttonPagination: {
       fontSize: 12,
       backgroundColor: 'rgb(217, 217, 217)',
       marginLeft: 5,
       width: '9%',
       height: 30,
       borderColor: '#000',
       borderWidth: 0.5,
       alignItems: 'center',
       justifyContent: 'center'
   },
   buttonPaginationActive: {
          fontSize: 12,
          backgroundColor: '#DB4437',
          marginLeft: 5,
          width: '9%',
          height: 30,
          borderColor: '#000',
          borderWidth: 0.5,
          alignItems: 'center',
          justifyContent: 'center'
      },
   pagination: {
       backgroundColor: 'rgba(0,0,0,0)',
       width: 400,
       position: 'absolute',
       right: 0,
       left: 0,
       bottom: 7,
       padding: 0,
       flex: 1,
       justifyContent: 'center',
       alignItems: 'center',
       flexDirection: 'row'
    },
    containerMarginTop: {
      marginTop: 30
    },
    footerStyle:
      {
        padding: 7,
        alignItems: 'center',
        justifyContent: 'center',
        borderTopWidth: 2,
        borderColor: '#607D8B'
      },

      TouchableOpacity_style:
      {
        padding: 7,
        flexDirection: 'row',
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: '#F44336',
        borderRadius: 5,
      },

      TouchableOpacity_Inside_Text:
      {
        textAlign: 'center',
        color: '#fff',
        fontSize: 18
      },

      flatList_items:
      {
        fontSize: 20,
        color: '#000',
        padding: 10
      }

});
/*
 initialNumToRender={50}
                    maxToRenderPerBatch={8}
                    onEndReachedThreshold={4}
*/
//ListFooterComponent = { this.Render_Footer }
//<DataTable style={{backgroundColor: 'rgb(217, 217, 217)'}}>
//                  <DataTable.Pagination
//                    page={this.state.page}
//                    numberOfPages={Math.floor(this.state.totalRow / this.state.perPage)}
//                    onPageChange={page => this.loadMoreOrderAPI(page)}
//                    label={`${this.state.page * this.state.perPage}-${(this.state.page +1) * this.state.perPage} of ${this.state.totalRow}`}
//                  />
//                </DataTable>