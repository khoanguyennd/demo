<?php

class QuestionController extends Controller {

    // Phương thức khởi tạo
    public function __construct($params) {
        parent::__construct($params);
        $this->isLogin();
        $account = $_SESSION['accountshopping'];
        if ($account['temp'] == 1)
            Url::header($this->route('account') . "#tab1");
    }

    // Phương thức index
    public function indexAction() {

        $account = $_SESSION['accountshopping'];
        //print_r($account);die();
        $items = [];
        $user_id = $account['idx'];
        $list_channel = array();
        $m_channel = array();
        $channel = $this->_model->loadRecords('channels');
        foreach ($channel as $value => $giatri) {
            $list_channel[] = array(
                $giatri['channel_id'],
                $giatri['channel_cid']
            );
            $m_channel[] = $giatri['channel_cid'];
        }
        $this->_view->setData('list_channel', $list_channel);
        $supplier = $this->_model->loadSupplier(Structure::getUserId());
        $this->_view->setData('supplierSelect', $supplier);
        $sqlheader = "SELECT q.*,d.*";
        $sqlcount = 'SELECT COUNT(q.`question_id`) as record ';
        $sql = ' FROM `tb_question` q LEFT JOIN (SELECT sc.travelProductId,sc.sellerProductId,sc.productId,sp.supplier,sp.name
                                                FROM tb_salechannel sc,tb_sellerproduct sp
                                                WHERE sc.sellerProductId=sp.sellerProductId ) d
                                        ON q.dealId=d.productId ';
        $sql .= ' WHERE q.isDelete=0 ';

        if (isset($this->_params['m_search'])) {
            $m_start = $this->_params['datestart'];
            $m_end = $this->_params['dateend'];
            $sql .= ' AND q.`question_created` BETWEEN "' . $m_start . ' 00:00:00' . '" AND "' . $m_end . ' 23:59:59' . '" ';
            $m_status = $this->_params['m_status'];
            if ($m_status != 0) {
                $sql .= ' AND q.`question_status`="' . $m_status . '"';
            }

            $m_supplier = $this->_params['m_supplier'];
            if ($m_supplier == 0) {
                if ($account['role'] != 0) {
                    $sql .= " AND d.supplier IN (( SELECT u.idx FROM `tb_user` u WHERE u.idx=$user_id OR u.idx_parent=$user_id))";
                }
            } else {
                $sql .= " AND d.supplier=" . $m_supplier;
            }

            $m_channel = array();
            if (isset($this->_params['m_channel'])) {
                $m_channel = $this->_params['m_channel'];
                $sql .= " AND ";
                $i = 1;
                foreach ($m_channel as $giatri => $value) {
                    if ($i == 1) {
                        $sql .= " ( q.channel_name = '" . $value . "'";
                    } else {
                        $sql .= " OR q.channel_name ='" . $value . "'";
                    }
                    if ($i == count($m_channel)) {
                        $sql .= ")";
                    }
                    $i++;
                }
            }

            $m_key = $this->_params['m_key'];
            $m_name = $this->_params['m_name'];
            if ($m_name != "") {
                if ($m_key == 0)
                    $sql .= " AND q.question_content LIKE '%$m_name%' ";
                if ($m_key == 1)
                    $sql .= " AND q.dealName LIKE '%$m_name%' ";
                if ($m_key == 2)
                    $sql .= " AND q.optionName LIKE '%$m_name%' ";
                if ($m_key == 3)
                    $sql .= " AND q.question_name LIKE '%$m_name%' ";
                if ($m_key == 4)
                    $sql .= " AND q.dealId LIKE '%$m_name%' ";
            }
        } else {
            $user_id = $account['idx'];
            if ($account['role'] != 0) {
                if ($account['role'] == 1) {
                    //lay ds các ncc  
                    $sql .= " AND d.supplier IN ( SELECT u.idx FROM `tb_user` u WHERE u.idx=$user_id OR u.idx_parent=$user_id)";
                } elseif ($account['role'] == 2) {
                    //nhà cung cấp
                    $sql .= " AND d.supplier=" . $user_id;
                }
            }
            $date = date("Y-m-d");
            $date = strtotime(date("Y-m-d", strtotime($date)) . "-2 months");
            $m_start = date("Y-m-d", $date);
            //$m_start = date("Y-m-d");
            $m_end = date("Y-m-d");
            $m_supplier = 0;
            $m_status = 1;
            $m_key = 0;
            $m_name = "";
            if ($this->_params['method'] == 'unreply') {
                $sql .= ' AND q.`question_status`=1 ';
            } else {
                $sql .= ' AND q.`question_status`=' . $m_status . ' ';
            }
        }
        $this->_view->setData('m_start', $m_start);
        $this->_view->setData('m_end', $m_end);
        $this->_view->setData('m_channel', $m_channel);
        $this->_view->setData('m_status', $m_status);
        $this->_view->setData('m_supplier', $m_supplier);
        $this->_view->setData('m_key', $m_key);
        $this->_view->setData('m_name', $m_name);

       // echo $sqlheader.$sql;
        $_SESSION['sqlquestion'] = $sql;
        $count = $this->_model->countQuestion($sqlcount . $sql);
        if ($_SESSION['mobile'] != 0) {
            $pagination = $this->paginationParamsmobi($count['record'], $this->route('question', ['method' => 'anwser']));
        } else {
            $pagination = $this->paginationParams($count['record'], $this->route('question', ['method' => 'anwser']));
        }

        $items = $this->_model->loadQuestions($sqlheader . $sql, $pagination['length'], $pagination['begin']);
        $this->_view->setData('length', $pagination['length']);
        $this->_view->setData('pagination', $pagination['pagination']);
        $this->_view->setData('total', $pagination['count']);
        // Nhà cung cấp
        $this->_view->setData('question', Helper::createRowQuestion($items, $pagination['length'], $pagination['begin']));
        $this->_view->setData('question_mobi', Helper::createRowQuestionmobi($items, $pagination['length'], $pagination['begin']));

        if ($_SESSION['mobile'] != 0) {
            $this->_view->setFileTemplate('web', 'temple_mobile');
            $this->_view->render('index_mobi');
        } else {
            $this->_view->render('index');
        }
    }

    // Phương thức index
    public function channelAction() {
        $account = $_SESSION['accountshopping'];
        $items = [];$user_id = $account['idx'];
        $channelname = $this->_params['channelname'];
        $list_channel = array();
        $m_channel = array();
        $channel = $this->_model->loadRecords('channels');
        foreach ($channel as $value => $giatri) {
            $list_channel[] = array(
                $giatri['channel_id'],
                $giatri['channel_cid']
            );
            $m_channel[] = $giatri['channel_id'];
        }
        $this->_view->setData('list_channel', $list_channel);
        $supplier = $this->_model->loadSupplier(Structure::getUserId());
        $this->_view->setData('supplierSelect', $supplier);
        
        $sqlheader = "SELECT q.*,d.*";
        $sqlcount = 'SELECT COUNT(q.`question_id`) as record ';
        $sql = ' FROM `tb_question` q LEFT JOIN (SELECT sc.travelProductId,sc.sellerProductId,sc.productId,sp.supplier,sp.name
                                                FROM tb_salechannel sc,tb_sellerproduct sp
                                                WHERE sc.sellerProductId=sp.sellerProductId ) d
                                        ON q.dealId=d.productId ';
        $sql .= ' WHERE 1 ';
        
        if ($channelname != "") {
            $sql .= " AND q.`channel_name` LIKE '" . $channelname . "' ";
        }
        $sql .= ' AND q.`question_status`=1 ';
        
        if ($account['role'] != 0) {
            if ($account['role'] == 1) {
                //lay ds các ncc  
                $res = $this->_model->setQuery('SELECT idx,idx_parent FROM `tb_user` WHERE idx=' . $user_id . ' OR idx_parent=' . $user_id);
                $userncc = $this->_model->readAll();
                $array_ncc = array();
                foreach ($userncc as $rows_user) {
                    $array_ncc[] = $rows_user['idx'];
                }
                $sql .= " AND d.supplier IN (" . implode(',', $array_ncc) . ")";
            } elseif ($account['role'] == 2) {
                //nhà cung cấp
                $sql .= " AND d.supplier=" . $user_id;
            }
        }
        $_SESSION['sqlquestion'] = $sql;
        $count = $this->_model->countQuestion($sqlcount . $sql);
        $pagination = $this->paginationParamsmobi($count['record'], $this->route('questionchannel', ['channelname' => 'channelname']));
        $items = $this->_model->loadQuestions($sqlheader . $sql, $pagination['length'], $pagination['begin']);
        $this->_view->setData('length', $pagination['length']);
        $this->_view->setData('pagination', $pagination['pagination']);
        $this->_view->setData('total', $pagination['count']);
        $this->_view->setData('question', Helper::createRowQuestionmobi($items, $pagination['length'], $pagination['begin']));
        $this->_view->setData('namechannel', $channelname);
        $this->_view->setFileTemplate('web', 'temple_mobile');
        $this->_view->render('channels_mobi');
    }

    // Phương thức phân trang ajax
    public function paginationAjax() {
        $result1 = ['flag' => false];
        // Tham số phân trang
        $length = ($this->_params['length'] ? $this->_params['length'] : DEFAULT_LENGTH);
        $page = ($this->_params['page'] ? $this->_params['page'] : 1);
        $begin = ($page - 1) * $length;

        $sqlheader = "SELECT q.*,d.*";
        $sqlcount = 'SELECT COUNT(q.`question_id`) as record ';
        $sql = $_SESSION['sqlquestion'];

        $this->_model->setQuery("SELECT count(*) as count " . $sql);
        $result = $this->_model->readAll();
        $this->_view->setData('count', $result[0]['count']);

        $count = $this->_model->countQuestion($sqlcount . $sql);
        $pagination = $this->paginationParams($count['record'], $this->route('question', ['method' => 'anwser']));
        $result1['divpaging'] = $pagination['pagination'];

        $items = $this->_model->loadQuestions($sqlheader . $sql, $length, $begin);

        $result1['divquestionbody'] = Helper::createRowQuestion($items, $length, $begin);
        $result1['flag'] = true;

        echo json_encode($result1);
    }

    // Phương thức phân trang ajax
    public function paginationmobiAjax() {
        $result1 = ['flag' => false];
        // Tham số phân trang
        $length = ($this->_params['length'] ? $this->_params['length'] : DEFAULT_LENGTH);
        $page = ($this->_params['page'] ? $this->_params['page'] : 1);
        $begin = ($page - 1) * $length;

        $sqlheader = "SELECT * ";
        $sqlcount = 'SELECT COUNT(`question_id`) as record ';
        $sql = $_SESSION['sqlquestion'];

        $this->_model->setQuery("SELECT count(*) as count " . $sql);
        $result = $this->_model->readAll();
        $this->_view->setData('count', $result[0]['count']);

        $count = $this->_model->countQuestion($sqlcount . $sql);
        $pagination = $this->paginationParams($count['record'], $this->route('question', ['method' => 'anwser']));
        $result1['divpaging'] = $pagination['pagination'];

        $items = $this->_model->loadQuestions($sqlheader . $sql, $length, $begin);
        $result1['divquestionbody'] = Helper::createRowQuestionmobi($items, $length, $begin);
        $result1['flag'] = true;
        echo json_encode($result1);
    }

    // Phương thức hiển thị form trả lời hoặc chỉnh sửa
    public function viewformAjax() {
        $result = ['flag' => false];
        if (isset($this->_params['qsid']) && is_numeric($this->_params['qsid'])) {
            $link_url=$this->_params['link_url'];
            $item = $this->_model->loadQuestion($this->_params['qsid']);
            if ($item) {
                $result['qsid'] = $item['question_id'];
                $result['qsproduct'] = $item['dealId'];
                $result['qsproductlink'] = '#';
                $result['link_url'] = $link_url;
                $result['createdreply'] = $item['reply_created'];
                $result['qsmessage'] = $item['question_content'];
                $result['qsreply'] = $item['reply_content'];
                $result['flag'] = true;
            }
        }
        echo json_encode($result);
    }
    // Phương thức websraping question
    public function websrapingAjax(){
        $result = ['flag'=>true];
        $StartDate = date("Y-m-d",strtotime("-3 day"));
        $EndDate = date('Y-m-d'); 

        //wemakeprice
        $wmp = new WemakepriceController($this->_params);
        $wmp->questionAction($StartDate, $EndDate);

        // //tmon
        //$tm = new TmonController($this->_params);
        //$tm->questionAction($StartDate, $EndDate);
        
        //gmarket
        $StartDate = date("Ymd",strtotime("-3 day"));
        $EndDate = date('Ymd'); 
        $gmk = new GmarketController($this->_params);
        //$gmk->questionAction("A", $StartDate, $EndDate);
        $gmk->questionAction("G", $StartDate, $EndDate);
        
//         // coupang
        $obj = new CoupangController($this->_params);
        $obj->questionAction($StartDate, $EndDate);
        
//         //11st
        $StartDate = date("Y/m/d",strtotime("-3 day"));
        $EndDate = date('Y/m/d'); 
        $st11st = new St11stController($this->_params);
        $st11st->questionAction($StartDate, $EndDate);

        // // //$this->route('channeltbridge')
        echo json_encode($result);
    }

    // Phương thức thực hiện trả lời hoặc chỉnh sửa câu trả lời
    public function excuteformAjax() {
        $result = ['flag' => false, 'createdreply' => ''];
        if (isset($this->_params['qsid']) && isset($this->_params['messagereply'])) {
            $result2 = $this->_model->loadRecord('question', ['question_id' => $this->_params['qsid']]);

            if ($result2) {
                $data = [
                    'reply_content' => $this->_params['messagereply'],
                    'question_status' => 2,
                    'reply_created' => date("Y-m-d H:i:s")
                ];
                if ($this->_model->updateQuestion($data, ['question_id' => $this->_params['qsid']]) != false) {
                    if ($result2['channel_name'] == 'WMAKE' ) {
                        $obj = new WemakepriceController($this->_params);
                        $obj->replyQuestionAction($result2['inquiryId'], $result2['dealId'], $this->_params['messagereply']);
                    }
                    if ($result2['channel_name'] == 'TMON' ) {
                        $obj = new TmonController($this->_params);
                        $obj->replyQuestionAction($result2['inquiryId'], $this->_params['messagereply']);
                    }
                    if ($result2['channel_name'] == 'GMKT' ) {
                        $obj = new GmarketController($this->_params);
                        $obj->replyQuestionAction($result2['inquiryId'], $this->_params['messagereply']);
                    }
                    if ($result2['channel_name'] == '11ST' ) {
                        $obj = new St11stController($this->_params);
                        $obj->replyQuestionAction($result2['inquiryId'], $this->_params['messagereply']);
                    }
                    
                    if ($result2['channel_name'] == 'COUPANG' ) {
                        $obj = new CoupangController($this->_params);
                        $obj->replyQuestionAction($result2['inquiryId'], $this->_params['messagereply']);
                    }
                    $result['flag'] = true;
                }
            }
        }
        echo json_encode($result);
    }

    // Phương thức download Excel
    public function downloadExcelAjax() {
        $format = Func::config('questionDownloadExcel');
        if ($format) {
            $sqlheader = "SELECT * ";
            $sql = $_SESSION['sqlquestion'];
            $items = $this->_model->loadQuestions($sqlheader . $sql, 10000, 0);
            if ($items) {
                $format['export']['titleName'] = $this->_params['titleName'];
                $format['export']['description'] = $this->_params['description'];
                $excel = new OfficeExcel();
                $excel->writeQuestion($format['filename'], $items, $format['columns'], $format['export'], $this->_params['titleName']);
            }
        }
    }

}

?>