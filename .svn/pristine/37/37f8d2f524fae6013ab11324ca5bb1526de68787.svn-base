<?php
$trandau = $this->getData('trandau');
$trandau_thanhvien = $this->getData('trandau_thanhvien');
$trandau_chitiet = $this->getData('trandau_chitiet');
$number_user = $trandau["soluong_user"];
$tongwin = $this->getData('tongwin');
$trandau_id = $trandau["id"];
$seconds = $this->getData('seconds');
$timesave = $this->getData('timesave');
$timemarch = $this->getData('timemarch');
$auto5s = $_SESSION["auto5s"];
$auto = $this->getData('auto');
$checkshowall = FALSE;
if (($tongwin + 1) == $number_user) {
    $checkshowall = TRUE;
}
?>
<div class="container-fluid">
    <div class="main-bgt mt-3" style="padding: 10px 20px !important">
        <div class="row">
            <div class="col-md-4 text-center">
                <div class="w-25 float-left mt-5 pt-2" style="margin-top: 10px !important;">
                    <a type="button" href="" class="btn btn-primary btn-blue-bn-t mb-1 ml-0 w-100" data-toggle="modal" data-target="#trogiupModal"><?= $this->language("l_help")?></a>
                </div>
            </div>
            <div class="col-md-4">
                <div class="time_march play_time">
                    <p id="countTimeMarch"><?= $timemarch ?></p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mt-4 float-right pt-1" style="width: 45%; margin-top: 0px !important;">
                    <button class="button_play">
                        <?= $this->language("l_play") ?> 
                        <?php if ($auto5s == 0) { ?>
                            <span id="timer">(5)</span>
                            <?php Session::set('auto5s', 1); ?>
                        <?php } ?>            
                    </button>
                    <button class="button_pause35"><?= $this->language("l_pause") ?></button>
                    <button class="button_stop3"><?= $this->language("l_conforms_end") ?></button>                                        
                </div>
            </div>
        </div>		
    </div>
    <div class="row mt-3">
        <div class="div_full35"></div>
        <?php 
        for ($i = 1; $i <= $number_user; $i++) {
            if($number_user==3&&$i==2){$class="col-md-4 pl-10 pr-10";}
            if($number_user==3&&($i==1||$i==3)){$class="col-md-4 pl-10";}
            if($number_user==4&&($i==2||$i==3)){$class="col-md-3 pr-10 pl-10";}
            if($number_user==4&&($i==1||$i==4)){$class="col-md-3 pr-10";}
            if($number_user==5&&($i==2||$i==3||$i==4)){$class="col-20 pr-10 pl-10";}
            if($number_user==5&&($i==1||$i==5)){$class="col-20 pr-10";}
            if($i==1){$class_point="gr";}
            if($i==2){$class_point="or";}
            if($i==3){$class_point="bln";}
            if($i==4){$class_point="bl";}
            if($i==5){$class_point="st";}
            $thanhvien_name = $this->getData('thanhvien_name' . $i);
            $thanhvien_diemketthuc = $this->getData('thanhvien_diemketthuc' . $i);
            $thanhvien_point = $this->getData('thanhvien_point' . $i);
            $thanhvien_win = $this->getData('thanhvien_win' . $i);
            $thanhvien_trandau_id = $trandau_thanhvien[$i - 1]['id'];
        ?>
        <div class="<?=$class?>">
            <div class="bgt-blue mb-3">
                <div class="star-player-top b-line pt-2 pb-0 pl-4">
                    <div class="row">
                        <div class="w-85 pr-0 pl-3">
                            <h3 class="name-item s-24"><?= $thanhvien_name ?></h3>
                        </div>
                        <div class="w-15 pl-0 float-right">
                            <div class="diem-chap-tv text-center s-50">
                                <span><?= $thanhvien_diemketthuc ?></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="star-player-main t-line b-line pt-5">
                    <div class="start_player_diem start_player_diem_color-<?=$class_point?> s-160 w-275 h-275">
                        <p class="pointusernow<?= $i ?>">
                            <span id="point">
                                <?php
                                    if ($thanhvien_point < 10) {echo "0" . $thanhvien_point;} else {echo $thanhvien_point;}
                                ?>
                            </span>
                        </p>
                    </div>
                    <input type="hidden" id="pointplay35<?= $i ?>" value="<?= $thanhvien_point ?>" />
                    <div id="groupaction<?= $i ?>" class="rowsplay_button start_player_button m-auto m-0 pt-4">
                        <?php if ($checkshowall) { ?>
                            <?php if ($thanhvien_win == 0) { ?>
                                <p class="places"><?= $this->language("l_hang") ?> <?= $tongwin + 1 ?></p>
                            <?php } else { ?>
                                <p class="places"><?= $this->language("l_hang") ?> <?= $thanhvien_win ?></p>
                            <?php } ?>
                        <?php } else { ?>
                            <?php if ($thanhvien_win == 0) { ?>
                                <button class="button_minus btn btn-primary btn-blue-n button_minus<?=$i?>" onclick="subpoint('<?= $i ?>', '<?= $thanhvien_name ?>', '<?= $thanhvien_diemketthuc ?>', '<?= $trandau_id ?>', '<?= $thanhvien_trandau_id ?>')" >
                                    <i class="fa fa-minus" aria-hidden="true"></i>
                                </button>
                                <button class="button_minus btn btn-primary btn-blue-n button_plus<?=$i?>"  onclick="addpoint('<?= $i ?>', '<?= $thanhvien_name ?>', '<?= $thanhvien_diemketthuc ?>', '<?= $trandau_id ?>', '<?= $thanhvien_trandau_id ?>')" >
                                    <i class="fa fa-plus"aria-hidden="true"></i>
                                </button>
                            <?php } else { ?>
                                <p class="places"><?= $this->language("l_hang") ?> <?= $thanhvien_win ?></p>
                            <?php } ?>
                        <?php } ?>
                    </div>
                </div>
                <div class="start_player_history t-line">
                    <div class="title_history">
                        <div class="row">
                            <div class="col-md-12 pt-2 text-left">
                                <p class="pl-4 pt-2"><?= $this->language("l_lichsutrandau")?></p>								
                            </div>
                        </div>
                    </div>
                    <div style="height: 312px;" class="main_history">
                        <div class="hide-scroll">
                            <div class="viewport" style="margin-top: 0px;">
                                <div class="history<?=$i?>"></div>
                                <?php            
                                    foreach ($trandau_chitiet as $td_ct){
                                        if($thanhvien_trandau_id==$td_ct['thanhvien_trandau_id']){
                                            echo $td_ct['content'];
                                        }
                                    }
                                ?>
                            </div>                            
                        </div>
                    </div>						
                </div>
            </div>
        </div>
        <?php }?>
    </div>    
</div>
<input type="hidden" id="timesave" value="<?= $timesave ?>" />
<input type="hidden" id="hidden_timesave" value="<?= $seconds ?>" />
<script>
    $(document).ready(function () {
        <?php if ($auto5s == 0) { ?>
            startAutoplay();
        <?php } ?>
        <?php if ($auto5s != 0) { ?>
            autoplay();
        <?php } ?>
        $(".button_play").click(function () {
            $(".button_play").css("display", "none");
            $(".div_full35").css("display", "none");
            $(".button_pause35").css("display", "initial");
            startCountTimeUser();
            $("#timer").remove();
        });
        $(".button_pause35").click(function () {
            $(".button_pause35").css("display", "none");
            $(".button_play").css("display", "initial");
            $(".div_full35").css("display", "block");
            stopCountTimeUser();
        });
        $(".button_stop3").click(function () {
            $('#confirmmode35Modal').modal('show');
        });
        $(".button_ok_mode35_end").click(function () {
            $('.div_load_alert').css("display", "block");
            window.location = "<?= $this->route('setting3') ?>";
        });
    });
    var count = 5;
    function startAutoplay() {
        var r = setInterval(function () {
            var timer = document.getElementById("timer");
            if (count > 0) {
                count--;
                timer.innerHTML = "(" + count + ")";
            } else {
                $(".button_play").css("display", "none");
                $(".div_full35").css("display", "none");
                $(".button_pause35").css("display", "initial");
                startCountTimeUser();
                $("#timer").remove();
                clearInterval(r);
            }
        }, 1000);
    }
    function autoplay() {
        $(".button_play").css("display", "none");
        $(".div_full35").css("display", "none");
        $(".button_pause35").css("display", "initial");
        startCountTimeUser();
    }
    function subpoint(pos, name, point, trandau_id, thanhvien_trandau_id) {
        var hidden_timesave = document.getElementById("hidden_timesave").value;
        var pointnow = document.getElementById("pointplay35" + pos).value;
        var pointold = pointnow;
        pointnow = parseInt(pointnow);
        if(pointnow>0){
            pointnow = pointnow - 1;
            document.getElementById("pointplay35" + pos).value = pointnow;
            if (pointnow < 10) {
                if (pointnow < 0) {
                    $(".pointusernow" + pos).html(pointnow);
                } else {
                    $(".pointusernow" + pos).html("0" + pointnow);
                }
            } else {
                $(".pointusernow" + pos).html(pointnow);
            }
            var timesave = document.getElementById("timesave").value;
            var str = '';
                str += '<div class="row b-line-d m-0 text-capitalize">';
                    str += '<div class="col-md-8 pt-2 text-left pl-4">';
                        str += '<p class="mb-1"><strong>[' + name + ']:</strong> -1 <?= $this->language("l_pointtb") ?></p>';
                        str += '<p><?= $this->language("l_thoigian") ?>: ' + timesave + '</p>';
                    str += '</div>';
                    str += '<div class="col-md-4 pt-2 text-right">';
                        str += '<p class="mb-1">' + pointold + '->' + pointnow + ' <?= $this->language("l_pointtb") ?></p>';
                    str += '</div>';
                str += '</div>';
            $('.history'+pos).after(str);
            var strload = '<img class="imagesloadleft" src="' + $baseUrl + '/public/img/load.gif" />';
            $(".button_minus" + pos).after(strload);            
            $(".rowsplay_button :input").prop("disabled", true);        
            $.fn_ajax('inningsavemode35', {'trandau_id': trandau_id, 'name': name, 'str': str, 'pointnow': pointnow, 'timesave': timesave, 'hidden_timesave': hidden_timesave, 'thanhvien_trandau_id': thanhvien_trandau_id}, function (result) {
                if (result.flag == true) {
                    $('.imagesloadleft').remove();
                    $(".rowsplay_button :input").prop("disabled", false);
                } else {
                    alert("Error");
                }
            }, true);
        }        
    }
    function addpoint(pos, name, point, trandau_id, thanhvien_trandau_id) {
        var numberplay =<?= $number_user ?>;
        var pointnow = document.getElementById("pointplay35" + pos).value;
        var hidden_timesave = document.getElementById("hidden_timesave").value;
        var pointold = pointnow;
        pointnow = parseInt(pointnow);
        pointnow = pointnow + 1;
        document.getElementById("pointplay35" + pos).value = pointnow;
        if (pointnow < 10) {
            if (pointnow < 0) {
                $(".pointusernow" + pos).html(pointnow);
            } else {
                $(".pointusernow" + pos).html("0" + pointnow);
            }
        } else {
            $(".pointusernow" + pos).html(pointnow);
        }
        var timesave = document.getElementById("timesave").value;        
        var str = '';
        str += '<div class="row b-line-d m-0 text-capitalize">';
            str += '<div class="col-md-8 pt-2 text-left pl-4">';
                str += '<p class="mb-1"><strong>[' + name + ']:</strong> +1 <?= $this->language("l_pointtb") ?></p>';
                str += '<p><?= $this->language("l_thoigian") ?>: ' + timesave + '</p>';
            str += '</div>';
            str += '<div class="col-md-4 pt-2 text-right">';
                str += '<p class="mb-1">' + pointold + '->' + pointnow + ' <?= $this->language("l_pointtb") ?></p>';
            str += '</div>';
        str += '</div>';
        $('.history'+pos).after(str);        
        $(".rowsplay_button :input").prop("disabled", true);
        var strload = '<img class="imagesload" src="' + $baseUrl + '/public/img/load.gif" />';
        $(".button_plus" + pos).after(strload);
        if (parseInt(pointnow) == parseInt(point)) {
            $.fn_ajax('inningsavemode35', {'trandau_id': trandau_id, 'name': name, 'str': str, 'pointnow': pointnow, 'timesave': timesave, 'hidden_timesave': hidden_timesave, 'thanhvien_trandau_id': thanhvien_trandau_id}, function (result) {
                if (result.flag == true) {
                    $('.imagesload').remove();
                    $.fn_ajax('savewinmode35', {'trandau_id': trandau_id, 'name': name, 'numberplay': numberplay, 'thanhvien_trandau_id': thanhvien_trandau_id}, function (result1) {
                        if (result1.flag == true) {
                            var str1 = '<p class="places"><?= $this->language("l_hang") ?> ' + result1.thutu + '</p>';
                            $("#groupaction" + pos).html(str1);
                            $("#groupaction" + pos).addClass('win');
                            $(".rowsplay_button :input").prop("disabled", false);
                            if (result1.showall == true) {
                                var thuhang = result1.thutu + 1;
                                var str2 = '<p class="places"><?= $this->language("l_hang") ?> ' + thuhang + '</p>';
                                $('div[class^="rowsplay_button"]').not('.win').html(str2);
                                if (thuhang == pos) {
                                    $('.button_pause35').hide();
                                }
                            }
                        }
                    }, true);
                } else {
                    alert("Error");
                }
            }, true);
        } else {
            $.fn_ajax('inningsavemode35', {'trandau_id': trandau_id, 'name': name, 'str': str, 'pointnow': pointnow, 'timesave': timesave, 'hidden_timesave': hidden_timesave, 'thanhvien_trandau_id': thanhvien_trandau_id}, function (result) {
                if (result.flag == true) {
                    $('.imagesload').remove();
                    $(".rowsplay_button :input").prop("disabled", false);
                } else {
                    alert("Error");
                }
            }, true);
        }
    }
</script>
<script type="text/javascript">
    var secondUseCurrent = <?= $seconds ?>; var timeUse; var timerOnUser = 0;
    function timedCountCurrentUser(){
        document.getElementById("hidden_timesave").value = secondUseCurrent;
        if (secondUseCurrent < 10) { txtSecond = '0' + parseInt(secondUseCurrent);} else { txtSecond = parseInt(secondUseCurrent);}
        secondUseCurrent = secondUseCurrent + 1;
        var h = Math.floor(Math.floor(txtSecond / 60) / 60);
        var m = Math.floor(txtSecond / 60);
        var s = txtSecond % 60;
        if (s < 10) { s = "0" + s;}
        if (m < 10) { m = "0" + m;}
        if (h < 10) { h = "0" + h;}
        $("#countTimeMarch").html(h + ":" + m);
        document.getElementById("timesave").value = h + ":" + m + ":" + s;
        timeUse = setTimeout("timedCountCurrentUser()", 1000);
    }
    function startCountTimeUser(){
        if (!timerOnUser){
            timerOnUser = 1;
            timedCountCurrentUser();
        }
    }
    function stopCountTimeUser() {
        if (timeUse) {
            timerOnUser = 0;
            clearTimeout(timeUse);
        }
    }
</script>
<div class="modal fade" id="confirmmode35Modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="max-width: 40%; top: 20%">
        <div class="modal-content bgt-blue">
            <div class="modal-body p-0 b-line">
                <div class="title text-center pb-3 b-line"><h3><?= $this->language("l_confirm_end") ?></h3></div>
            </div>
            <div class="modal-footer t-line pb-4 pt-4">
                <div class="m-0 m-auto">
                    <button type="button" class="btn btn-primary btn-blue" data-dismiss="modal"><?= $this->language("l_close") ?></button>
                    <button type="button" class="btn btn-primary btn-blue button_ok_mode35_end"><?= $this->language("l_ok") ?></button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="div_load_alert">
    <div class="main_mess">
        <p><?= $this->language("l_main_mess") ?></p>
        <img style="width: 200px;" src="<?= URL_PUBLIC ?>img/load.gif" />
    </div>
</div>
<style>
    .button_play,.button_pause35,.button_stop3 {background: #0261b1; border: #0485e9 1px solid; box-shadow: #000 0px 6px 8px; font-size: 20px; text-transform: uppercase;border-radius: 10px; padding: 8px 25px; margin: 0 5px; font-family: utm avo; font-weight: 500; color: #fff; width: 100%;}
    .button_play:hover,.button_pause35:hover,.button_stop3:hover{background: #0485e9;}      
    .button_stop3{margin-top: 5px; padding: 8px 5px !important;}
    .div_full35{position: fixed;top: 80px; left: 0px; bottom: 0px;right: 0px; z-index: 1000; width: 100%; height: 100%; display: block;}
    .places{margin-bottom: 0px; font-size: 42px; text-align: center;}
    .rowsplay_button{position: relative;}
    .imagesload{width: 85px;position: absolute;right: 6px;top: 31px;height: 48px;background: #0179df;}
    .imagesloadleft{width: 85px;position: absolute;left: 6px;top: 31px;height: 48px;background: #0179df;}
    .button_pause35{display: none;}    
    .viewport {overflow: auto;height: 120%;margin-right: 0px;margin-top: 20px;}
    .hide-scroll {overflow: hidden;}
    .hide-scroll {height: 82%;position: relative;}
    .hide-scroll:after {content: '';height: 2em;position: absolute;bottom: 0;left: 0;right: 0;}
    #countTimeMarch{margin-bottom: 0px;}
    .time_march{font-size: 70px;}
    .star-player-top{padding-top: 0px !important;}
</style>