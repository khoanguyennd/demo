<?php
require PATH_ROOT . '/vendor1/autoload.php';
use Goutte\Client;
use Symfony\Component\HttpClient\HttpClient;
use Symfony\Component\BrowserKit\HttpBrowser;
use Symfony\Component\DomCrawler\Crawler;

require PATH_ROOT . '/vendor/autoload.php';
use Google\Cloud\Storage\StorageClient;

class GmarketController extends Controller {
    
    // Phương thức khởi tạo
    public function __construct($params) {
        parent::__construct($params);
    }
   
    // Phương thức index
    public function indexAction() {
        
        $data =[    'Password' => 'yakeun87!@',
                    'Type' => 'S',
                    'ReturnUrl' => 'http://www.esmplus.com/Home/Home',
                    'SiteType' => 'GMKT',
                    'Id' => 'ysjlabs',
                    'RememberMe' => 'true',
                    'RememberMe' => 'false'  ];

        $client = new Client(HttpClient::create(['timeout' => 60]));
        $client->request('POST', 'https://www.esmplus.com/SignIn/Authenticate',$data);
        
        $startDate = '2020-06-30';
        //$lastYear = date('Y') -1;
        //$startDate = $lastYear . date("-m-d");
        $endDate = Date('Y-m-d');
        //get total
        $dataInputCount=[
            'siteGbn' => 0,
            'searchAccount' =>  '459268',
            'searchDateType' => 'TRD',
            'searchSDT' => $startDate,
            'searchEDT' => $endDate,
            'searchKey' => 'ON',
            'searchKeyword' => '',
            'searchStatus' => '5010',
            'searchAllYn' => 'N',
            'SortFeild' => 'TransDate',
            'SortType' => 'Desc',
            'start' => 0,
            'searchDistrType' => 'AL',
            'searchGlobalShopType' => '', 
            'searchOverseaDeliveryYn'=> ''
        ];
        $client->request("POST", "https://www.esmplus.com/Escrow/Delivery/GetBuyDecisionTabCount", $dataInputCount);
        $totalCount = json_decode($client->getResponse()->getContent(), true);
        $maxPages = ceil((int)$totalCount["totalCnt"]/20);

        $data = [             
            'limit' => 20,
            'siteGbn' => 0,
            'searchAccount' => '459268',
            'searchDateType' => 'TRD',
            'searchSDT' => $startDate,
            'searchEDT' => $endDate,
            'searchKey' => 'ON',
            'searchKeyword' => '',
            'searchStatus' => '5010',
            'searchAllYn' => 'N',
            'SortFeild' => 'TransDate',
            'SortType' => 'Desc',
            'start' => 0,
            'searchDistrType' => 'AL',
            'searchGlobalShopType' => '',
            'searchOverseaDeliveryYn' => ''            
        ];

        $orderGmarket = [];
        for($i=1; $i <= $maxPages; $i++ ){
            $data['page'] = $i;
            $client->request('POST', 'https://www.esmplus.com/Escrow/Delivery/BuyDecisionSearch',$data);
            $orderGmarket = array_merge($orderGmarket, json_decode($client->getResponse()->getContent(),true)['data']);
        }
        echo "<pre>";
        print_r($orderGmarket);        
        
//         $result = $this->insertOrderData($orderGmarket);
//         if($result){
//             echo "update data successfully";
//         }

    }
    private function insertOrderData($orderData){
        if(isset($orderData) && is_array($orderData) && count($orderData)){
            foreach ($orderData as $key => $val) {
                $ticket = [
                    'useAmount' => $val['TotalCnt'],
                    'totalAmount' => $val['TotalCnt'],
                    'ticketNumber' => $val['InvoiceNo'],
                    'price' => str_replace(",", "", $val['SupplyPrice']),
                    'purchasedAt' => $val['PayDate'],
                    //'canceledAt' => $val['PayExpireDate'],
                    'optionId' => "",
                    'dealId' => $val['GoodsNo']
                ];
                $queryTicket = $this->_model->loadRecord('ticket', ['ticketNumber' => $val['InvoiceNo']]);
                if ($queryTicket) {
                    $this->_model->updateRecord('ticket', $ticket, ['ticketNumber' => $val['InvoiceNo']]);
                } else {
                    $this->_model->insertRecord('ticket', $ticket);
                }
                $SiteID=$val['SiteID'];
                $SiteID=str_replace('<strong class="c_018f10">', '', $SiteID);
                $SiteID=str_replace('<strong class="c_ff0909">', '', $SiteID);
                $SiteID=str_replace('</strong>', '', $SiteID);
                $dealName=str_replace('</span>', '', $val['GoodsName']);
                $dealName= explode('">',$dealName);
                $dealName=$dealName[1];
                $ticketPurchasers = [
                    'orderNumber' => $val['OrderNo'],
                    'ticketNumber' => $val['InvoiceNo'],
                    'userName' => $val['BuyerName'],
                    'phoneNumber' => $val['BuyerHt'],
                    'dealId' => $val['GoodsNo'],
                    'dealName' => $dealName,
                    'optionId' => "",
                    'optionName' => "",
                    'price' => str_replace(",", "", $val['SupplyPrice']),
                    'purchaseDateTime' => $val['PayDate'],
                    'paymentDateTime' => $val['TransDate'],
                    'fee' =>  str_replace(",", "", $val['ServiceUseAmnt']),
                    'status' => 'COMPLETE',
                    'channel_name' =>  $SiteID
                ];
                $queryTicketPurchasers = $this->_model->loadRecord('ticketPurchasers', ['ticketNumber' => $val['InvoiceNo']]);
                if ($queryTicketPurchasers) {
                    $this->_model->updateRecord('ticketPurchasers', $ticketPurchasers, ['ticketNumber' => $val['InvoiceNo']]);
                }else {
                    $this->_model->insertRecord('ticketPurchasers', $ticketPurchasers);
                }
            }
            return true;
        }
        return false;
    }   
    public function questionAction(){
        $channel='G';
        if(isset($this->_params['channel']))
            $channel=$this->_params['channel'];
        
        $data =[    'Password' => 'yakeun87!@',
                'Type' => 'S',
                'ReturnUrl' => 'http://www.esmplus.com/Home/Home',
                'SiteType' => 'GMKT',
                'Id' => 'ysjlabs',
                'RememberMe' => 'true',
                'RememberMe' => 'false'  ];
        $client = new Client(HttpClient::create(['timeout' => 60]));
        $client->request('POST', 'https://www.esmplus.com/SignIn/Authenticate',$data);
        
        $lastYear = date('Y') -1;
        $StartDate = $lastYear . date("md");
        $EndDate = date('Ymd');     
      
        $dataQuestion['page'] =1;
        $dataQuestion['limit'] =20;
        $paramsData=[
            "Site" => $channel,
            "Account" => "All",
            "DateType" => "DA",
            "StartDate" => $StartDate,
            "EndDate" => $EndDate,
            "InquryType" => "AL",
            "QueryType" => "AL",
            "ReplyType" => "AL",
            "KeywordType" => "KC",
            "Keyword" => "",
            "OrderType" => "0",
            "PageSize" => 20,
            "CurrentPage" => 1,
            "TotalCount" => 0            
        ];
        $dataQuestion['paramsData'] = json_encode($paramsData);
        $dataQuestion['SortFeild'] = 'ItemNo';
        $dataQuestion['SortType'] = 'Asc';
        
        $client->request("POST", "https://www.esmplus.com/Member/CustomerService/GetInquryList", $dataQuestion);  
        $results = json_decode($client->getResponse()->getContent(), true);
        echo "<pre>";
        print_r($results);
        $questionData=[];
        if($results['success']==1){
            foreach ($results['data'] as $value) {
                if($value['ReplyType']=='처리완료'){ // đã trả lời
                    $detail=[
                        'SeqNo' => $value['SeqNo'],
                        'Token' => $value['Token']
                    ];
                    $client->request("POST", "https://www.esmplus.com/Member/CustomerService/GetInquiryDetail", $detail);  
                    $html= $client->getResponse()->getContent();
                    
                    $value['questionDetail']['date']='2020-08-05 14:38:33';
                    $value['questionDetail']['content']='test';
                }else{
                    $value['questionDetail']['date']='2020-08-05 14:38:33';
                    $value['questionDetail']['content']='test';
                }
                $questionData[]=$value;
            }
            
            $this->insertQuestionData($questionData);
        }
    }
    private function insertQuestionData($questionData){
        foreach ($questionData as $value) {
            $pieces = explode(" ", $value['ItemNo']);
            $data = [
                'question_name' => $value['BuyerName'],
                'question_email' => "",
                'question_content' => $value['Content'],
                'question_created' => $value['InsDate'].":00",
                'question_status' => 1,
                'orderNumber' => $value['OrderNo'],
                'dealName' => "",
                'dealId' =>$pieces[0],
                'question_purchase' => "",
                'channel_name' => $value['SiteType'],
                'inquiryId' => $value['SeqNo']
            ];
            if ($value['ReplyType'] == "처리완료") {
                $data['question_status'] = 2;
                $data['reply_name'] = $value['SellerId'];
                $data['reply_email'] = "";
                $data['reply_created'] =$value['questionDetail']['date'];
                $data['reply_content'] = $value['questionDetail']['content'];
            }
            
            $inquiryId = trim($value['SeqNo']);
            $result = $this->_model->loadRecord('question', ['inquiryId' => $inquiryId]);
            if ($result) {
                $this->_model->updateRecord('question', $data, ['inquiryId' => $inquiryId]);
            } else {
                $this->_model->insertRecord('question', $data);
            }
        }
        
    }
}

?>